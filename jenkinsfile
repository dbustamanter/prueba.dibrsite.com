pipeline {
    agent any
    tools {
        nodejs "node"
    }
    environment {
        TESTPLAN = "IXR-94"
        TAG = "@TEST_IXR-93"
    }
    stages {
        stage('CleanWorkspace') {
            steps {
                cleanWs()
            }
        }
        stage('gitClone') {
          steps {
            git branch: 'demo', url: 'https://github.com/dbustamanter/prueba.dibrsite.com.git'
          }
          post {
            success {
              echo 'La clonaci贸n del repositorio ha sido exitosa'
            }
            failure {
              echo 'La clonaci贸n del repositorio ha fallado'
            }
          }
        }
        stage('Pruebas unitarias') {
        steps {
            sh 'npm install'
            script {
                try {
                    def testResult = sh(returnStdout: true, script: 'npm test || exit 1')
                    echo "Resultado de la prueba: ${testResult}"
                } catch (err) {
                    if (err instanceof hudson.AbortException && err.getMessage().contains("exit code 1")) {
                        echo "La prueba fall贸. Por favor, revise su c贸digo."
                        throw err
                    } else {
                        echo "Prueba exitosa"
                        throw err
                    }
                }
            }
        }
    }
    stage('Deploy QA') {
      steps {
        sh 'cp -r $WORKSPACE/* /var/www/html/qa'
      }
      post {
        success {
          echo 'El despliegue al ambiente QA ha sido exitoso'
        }
        failure {
          echo 'El despliegue al ambiente QA ha fallado'
        }
      }
    }
}
}
